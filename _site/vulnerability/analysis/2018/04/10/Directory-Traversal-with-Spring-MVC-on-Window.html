<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Directory Traversal with Spring MVC on Windows</title>
  <link rel="icon" href="/favicon.ico">
  <link rel="apple-touch-icon" href="/public/img/head.png">
  <link rel="stylesheet" href="/public/css/amazeui.min.css">
  <link rel="stylesheet" href="/public/css/app.css">
  <link rel="stylesheet" href="/public/css/highlight-js/github.css">
</head>
<body>

<div class="am-container lp-container">
  <header class="am-topbar lp-topbar">
    <h1 class="am-topbar-brand">
      <a href="/">Tomato's Blog</a>
    </h1>
    <button class="am-topbar-btn am-topbar-toggle am-btn am-btn-sm am-btn-danger am-show-sm-only" data-am-collapse="{target: '#lp-topbar-collapse'}"><span class="am-sr-only">导航切换</span> <span class="am-icon-bars"></span></button>
    <div class="am-collapse am-topbar-collapse am-topbar-right" id="lp-topbar-collapse">
      <ul class="am-nav am-nav-pills am-topbar-nav">
        <li><a href="/">Archives</a></li>
        <!-- <li><a href="#">Categories</a></li> -->
        <li><a href="/friends.html">Friends</a></li>
        <!-- <li><a href="#">About Me</a></li> -->
        <li><a href="/feed.xml">Feed</a></li>
      </ul>
    </div>
  </header>
</div>


<div class="am-container lp-container">
  <div class="lp-post">
    <div class="lp-post-header">
      <h1 class="lp-post-title">Directory Traversal with Spring MVC on Windows</h1>
      <div class="lp-post-meta">
        <i class="am-icon-calculator"></i><span class="lp-post-date">2018-04-10</span>
        <i class="am-icon-tags"></i><span class="lp-post-tags">vulnerability analysis</span>
      </div>
    </div>
    <div class="lp-post-content">
    <h2 id="0x01-漏洞利用环境">0x01 漏洞利用环境</h2>

<p>web代码 https://github.com/spring-projects/spring-mvc-showcase</p>

<p>中间件 jetty</p>

<p>操作系统 Windows</p>

<h2 id="0x02-细节分析">0x02 细节分析</h2>

<p>这个漏洞存在下面几个限制条件</p>
<ol>
  <li>要使用file协议打开资源文件目录</li>
  <li>Windows平台</li>
  <li>不能使用Tomcat或者wildfy等中间件</li>
</ol>

<p>漏洞是出在Spring Framework处理自定义静态文件的功能处。通过阅读官方手册得知，在Spring Framework中有两种方式去定义资源文件。一种是配置XML文件，经常可以在Spring项目中看到如下配置</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;mvc:resources mapping="/resources/**" location="/public, classpath:/static/"  cache-period="31556926" /&gt;
</code></pre></div></div>
<p>另外一种方式就是通过重写<code class="highlighter-rouge">WebMvcConfigurer</code>中的<code class="highlighter-rouge">addResourceHandlers</code>方法来添加新的资源文件路径。其中使用<code class="highlighter-rouge">addResourceLocations</code>属性来设置资源文件内容时，它是支持http file等协议的。例如如下代码</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>registry.addResourceHandler("/resources/**").addResourceLocations("http://www.resources.com/","/resources/");
</code></pre></div></div>
<p>其含义就是你在访问http://www.xxx.com/resources/1.txt 时，Spring会去寻找www.resources.com是否存在此文件。当然file也同理。我们使用spring自己提供的demo，只要在<code class="highlighter-rouge">org.springframework.samples.mvc.config.WebMvcConfig</code>添加以下代码即可</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>registry.addResourceHandler("/resources/**").addResourceLocations("file:///D:/static/","/resources/");
</code></pre></div></div>
<p>当前漏洞环境在D盘，我在D盘根目录创建一个123.txt，通过下面的URL即可访问。 <a href="http://127.0.0.1:8080/spring-mvc-showcase/resources/xxxx/..%5c/..%5c/..%5c/123.txt">http://127.0.0.1:8080/spring-mvc-showcase/resources/xxxx/..%5c/..%5c/..%5c/123.txt</a>
<img src="/old_img/2018-04-11-21-48-47.jpg" alt="21-48-47" />
漏洞只能在windows上存在原因是因为为在<code class="highlighter-rouge">org/springframework/web/servlet/resource/ResourceHttpRequestHandler</code>中的<code class="highlighter-rouge">String path = (String) request.getAttribute(HandlerMapping.PATH_WITHIN_HANDLER_MAPPING_ATTRIBUTE);</code>会将URL中的<code class="highlighter-rouge">..%2f</code>去除,然后在Windows中能通过..\的方式来跳目录。然后不支持Tomcat的原因为在默认情况下Tomcat遇到包含%2f() %5c(/)的URL直接http 400，若需要处理此类型的URL 则需要在tomcat配置文件中添加<code class="highlighter-rouge">Dorg.apache.tomcat.util.buf.UDecoder.ALLOW_ENCODED_SLASH=true</code>   Spring Framework处理资源文件的整个流程如下图：
<img src="/old_img/2018-04-11-21-43-23.jpg" alt="21-43-23" /></p>

<p>在经过一系列判断之后在<code class="highlighter-rouge">org/springframework/util/ResourceUtils</code>中的<code class="highlighter-rouge">getFile</code>方法读取了文件。值得注意的是在虽然在存在URL检查中存在如下代码</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if (path.contains("WEB-INF") || path.contains("META-INF")) {
			if (logger.isTraceEnabled()) {
				logger.trace("Path contains \"WEB-INF\" or \"META-INF\".");
			}
			return true;
</code></pre></div></div>
<p>但是在Windows平台下是不会区分大小写的，所以还是可以读取配置文件。但是如何构造URL得看在配置资源文件中设置的location是在何处了。</p>

<p><img src="/old_img/2018-04-11-22-07-52.jpg" alt="22-07-52" />
官方修复方式是在<code class="highlighter-rouge">CheckResource</code>方法中添加了如下过滤</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>protected String processPath(String path) {
		path = StringUtils.replace(path, "\\", "/");
		path = cleanDuplicateSlashes(path);
		return cleanLeadingSlash(path);
	}
</code></pre></div></div>
<p>替换了\之后都成为了../ 自然就不能跨目录读文件了。</p>

<h2 id="0x03-参考">0x03 参考</h2>

<p>https://docs.spring.io/spring-framework/docs/5.0.4.RELEASE/spring-framework-reference/web.html#mvc-config-static-resources</p>

<p>https://pivotal.io/security/cve-2018-1271</p>

<p>https://threathunter.org/topic/5acc0902ec721b1f1966f582</p>


    </div>
    
    <div id="disqus_thread"></div>
<script type="text/javascript">
var disqus_shortname = "tomatos-blog";

/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
  </div>
</div>

<div class="am-container lp-container">
  <footer class="am-footer lp-footer">
    <p>Copyright © 2014-2017 All Rights Reserved</p>
    <p>Theme By <a href="https://github.com/RickGray/light-post">LightPost</a></p>
  </afooter>
</div>


<div data-am-widget="gotop" class="am-gotop am-gotop-fixed">
  <a href="#top" title="回到顶部">
    <span class="am-gotop-title">GoTop</span>
    <i class="am-gotop-icon am-icon-chevron-up"></i>
  </a>
</div>

<script src="/public/js/jquery.min.js"></script>
<script src="/public/js/amazeui.min.js"></script>
<script>
$(document).ready(function(){
  $.AMUI.progress.start();
});
$(window).load(function(){
  $.AMUI.progress.done();
});
</script>
<script src="/public/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<!-- 网站统计代码 -->
<div hidden>
<script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1256394309'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s95.cnzz.com/z_stat.php%3Fid%3D1256394309%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));</script>
</div>
<div hidden>
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?b8f48a0cd4b04ec22678a4cd23fcb9dd";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
</div>
</body>
</html>
